//- search.pug
div.search-bar-container
  .search-container
    .menu-button-wrapper
      button(onclick='category()' class="drop-button menu-button")
        i.fas.fa-list-ul.me-2
        | Danh Mục Sách
    form.search-bar(action="" method="get" id="form-search")
      .search-input-wrapper
        i.fas.fa-search.search-icon
        input.search-input(type="text" name="query" id="query" placeholder="Tìm sách, tác giả, sản phẩm mong muốn...")
      button.search-button(type="submit") 
        i.fas.fa-arrow-right.me-2
        | Tìm kiếm
    button.filter-button(data-bs-toggle="modal" data-bs-target="#filterModal")
      i.fas.fa-filter.me-2
      | Bộ lọc
    button.my-books-button(onclick="location.href='/saved'")
      i.fas.fa-book.me-2
      | Sách của tôi

  // Filter Modal
  #filterModal.modal.fade(tabindex="-1" aria-labelledby="filterModalLabel" aria-hidden="true")
    .modal-dialog.modal-lg
      .modal-content
        .modal-header
          h5#filterModalLabel.modal-title Bộ Lọc Tìm Kiếm
          button.btn-close(type="button" data-bs-dismiss="modal" aria-label="Close")
        .modal-body
          .row
            .col-md-6.mb-3
              h6 Thể Loại
              .form-check
                input#fictionCategory.form-check-input(type="checkbox" value="1")
                label.form-check-label(for="CNTT và Truyền thông") CNTT và Truyền thông
              .form-check
                input#scienceCategory.form-check-input(type="checkbox" value="2")
                label.form-check-label(for="CN Hóa - Thực phẩm - SH ứng dụng") CN Hóa - Thực phẩm - SH ứng dụng
              .form-check
                input#historyCategory.form-check-input(type="checkbox" value="3")
                label.form-check-label(for="Điện, Điện tử và Viễn thông") Điện, Điện tử và Viễn thông
              .form-check
                input#historyCategory.form-check-input(type="checkbox" value="4")
                label.form-check-label(for="Công nghệ và Kỹ thuật Cơ khí") Công nghệ và Kỹ thuật Cơ khí
              .form-check
                input#historyCategory.form-check-input(type="checkbox" value="5")
                label.form-check-label(for="Chế biến Sợi, Vải, Giày, Da") Chế biến Sợi, Vải, Giày, Da
              .form-check
                input#historyCategory.form-check-input(type="checkbox" value="6")
                label.form-check-label(for="Khoa học vật chất") Khoa học vật chất
              .form-check
                input#historyCategory.form-check-input(type="checkbox" value="7")
                label.form-check-label(for="Toán ứng dụng") Toán ứng dụng
            .col-md-6.mb-3
              h6 Khoảng Giá
              .input-group
                input.form-control(type="number" placeholder="Từ" id="priceFrom")
                span.input-group-text -
                input.form-control(type="number" placeholder="Đến" id="priceTo")

            .col-md-6.mb-3
              h6 Lượt thích
              .form-check
                input#rating4.form-check-input(type="radio" name="ratingRadio" value="10")
                label.form-check-label(for="rating10") 0 - 10 lượt thích
              .form-check
                input#rating3.form-check-input(type="radio" name="ratingRadio" value="20")
                label.form-check-label(for="rating20") 10 - 20 lượt thích
              .form-check
                input#rating3.form-check-input(type="radio" name="ratingRadio" value="50")
                label.form-check-label(for="rating50") 20 - 50 lượt thích
              .form-check
                input#rating3.form-check-input(type="radio" name="ratingRadio" value="51")
                label.form-check-label(for="rating51") Trên 50 lượt thích
            
            .col-md-6.mb-3
              h6 Năm xuất bản
              .form-check
                input#rating4.form-check-input(type="radio" name="yearRadio" value="2024")
                label.form-check-label(for="2024") 2024
              .form-check
                input#rating3.form-check-input(type="radio" name="yearRadio" value="2023")
                label.form-check-label(for="2023") 2023
              .form-check
                input#rating3.form-check-input(type="radio" name="yearRadio" value="2022")
                label.form-check-label(for="2022") 2022
              .form-check
                input#rating3.form-check-input(type="radio" name="yearRadio" value="2021")
                label.form-check-label(for="2021") Trước 2022
            .col-md-6.mb-3 
              h6 Ngôn ngữ
              .form-check
                input#language1.form-check-input(type="checkbox" value="Tiếng Việt")
                label.form-check-label(for="language1") Tiếng Việt
              .form-check
                input#language2.form-check-input(type="checkbox" value="Tiếng nước ngoài")
                label.form-check-label(for="language2") Tiếng nước ngoài
              


        .modal-footer
          button.btn.btn-secondary(type="button" data-bs-dismiss="modal") Đóng
          button.btn.btn-primary(type="button" id="applyFilters") Áp Dụng

style.
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
  @import url('https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css');
  @import url('https://cdnjs.cloudflare.com/ajax/libs/bootstrap/5.2.3/css/bootstrap.min.css');

  :root {
    --primary-color: #3b82f6;
    --secondary-color: #10b981;
    --background-color: #f0f9ff;
    --text-color: #1f2937;
    --border-radius: 12px;
    --transition: all 0.3s ease;
  }

  body {
    font-family: 'Inter', sans-serif;
  }

  .search-bar-container {
    padding: 20px;
    background-color: var(--background-color);
  }

  .search-container {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 15px 30px;
    background-color: white;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.05);
    border-radius: var(--border-radius);
    max-width: 1200px;
    margin: 0 auto;
    transition: var(--transition);
  }

  .search-container .menu-button, 
  .search-container .filter-button, 
  .search-container .my-books-button {
    padding: 12px 20px;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    border-radius: var(--border-radius);
    transition: var(--transition);
    font-weight: 500;
    margin-right: 15px;
  }

  .search-container .menu-button {
    background-color: var(--primary-color);
    color: white;
  }

  .search-container .filter-button {
    background-color: white;
    color: var(--primary-color);
    border: 2px solid var(--primary-color);
  }

  .search-container .menu-button:hover {
    background-color: #2563eb;
    transform: translateY(-3px);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
  }

  .search-container .filter-button:hover {
    background-color: var(--primary-color);
    color: white;
    transform: translateY(-3px);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
  }

  .search-container .search-bar {
    flex-grow: 1;
    display: flex;
    align-items: center;
    max-width: 700px;
    margin: 0 15px;
  }

  .search-container .search-input-wrapper {
    flex-grow: 1;
    position: relative;
    margin-right: -1px;
  }

  .search-container .search-icon {
    position: absolute;
    left: 15px;
    top: 50%;
    transform: translateY(-50%);
    color: #6b7280;
    transition: var(--transition);
  }

  .search-container .search-input {
    width: 100%;
    padding: 12px 12px 12px 40px;
    border: 1px solid #e5e7eb;
    border-radius: var(--border-radius) 0 0 var(--border-radius);
    font-size: 16px;
    transition: var(--transition);
  }

  .search-container .search-input:focus {
    outline: none;
    border-color: var(--primary-color);
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
  }

  .search-container .search-input:focus + .search-icon {
    color: var(--primary-color);
  }

  .search-container .search-button {
    background-color: var(--primary-color);
    color: white;
    padding: 12px 20px;
    border: none;
    border-radius: 0 var(--border-radius) var(--border-radius) 0;
    cursor: pointer;
    display: flex;
    align-items: center;
    font-weight: 500;
    transition: var(--transition);
  }

  .search-container .search-button:hover {
    background-color: #2563eb;
    transform: translateY(-3px);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
  }

  .search-container .my-books-button {
    background-color: white;
    color: var(--primary-color);
    border: 2px solid var(--primary-color);
  }

  .search-container .my-books-button:hover {
    background-color: var(--primary-color);
    color: white;
    transform: translateY(-3px);
    box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
  }

  // Modal Styling
  .modal-content {
    border-radius: var(--border-radius);
  }

  .modal-header {
    border-bottom: none;
    padding: 1.5rem;
  }

  .modal-footer {
    border-top: none;
    padding: 1.5rem;
  }

  .form-check-input:checked {
    background-color: var(--primary-color);
    border-color: var(--primary-color);
  }
  .menu-button-wrapper {
    position: relative;
  }

  .dropdown-menu-category {
    position: absolute;
    top: 100%;
    left: 0;
    width: 280px;
    background-color: white;
    border-radius: var(--border-radius);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
    z-index: 9999;
    display: none;
    padding: 10px 0;
    margin-top: 5px;
  }

  .dropdown-item-category {
    padding: 12px 20px;
    color: var(--text-color);
    text-decoration: none;
    display: block;
    transition: var(--transition);
    font-size: 14px;
  }

  .dropdown-item-category:hover {
    background-color: var(--background-color);
    color: var(--primary-color);
  }

  .dropdown-menu-category.show {
    display: block;
    animation: fadeIn 0.2s ease-in-out;
  }

  @keyframes fadeIn {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  @media (max-width: 768px) {
    .search-container {
      flex-direction: column;
      align-items: stretch;
      padding: 15px;
    }

    .search-container > * {
      margin-bottom: 10px;
      width: 100%;
    }

    .search-container .menu-button, 
    .search-container .filter-button,
    .search-container .my-books-button {
      justify-content: center;
    }

    .search-container .search-bar {
      margin: 0;
    }

    .search-container .search-input-wrapper,
    .search-container .search-button {
      width: 100%;
    }

    .search-container .search-input {
      border-radius: var(--border-radius);
    }

    .search-container .search-button {
      border-radius: var(--border-radius);
      margin-top: 10px;
    }
  }


script.
  document.getElementById('applyFilters').addEventListener('click', function() {
    const categories = Array.from(document.querySelectorAll('input[type="checkbox"]:checked'))
      .map(el => el.value);
    const priceFrom = parseInt(document.getElementById('priceFrom').value) || 0;
    const priceTo = parseInt(document.getElementById('priceTo').value) || 0;
    const year = parseInt(document.querySelector('input[name="yearRadio"]:checked')?.value) || 0;
    const likes = parseInt(document.querySelector('input[name="ratingRadio"]:checked')?.value) || 0;
    const languages = Array.from(document.querySelectorAll('input[id^="language"]:checked'))
      .map(el => el.value);

    console.log('Applied Filters:', {
      categories,
      priceFrom,
      priceTo,
      year,
      likes,
      languages
    });
    const queryParams = new URLSearchParams({
      categories: categories.join(','),
      priceFrom,
      priceTo,
      year,
      likes,
      languages: languages.join(',')
    }).toString();
    fetch(`/filter?${queryParams}`, {
      method: 'GET',
      headers: {
      'Content-Type': 'application/json'
      }
    })
    .then(res => {
      if (res.ok) {
      window.location.href = `/filter?${queryParams}`;
      } else {
      console.error('Failed to fetch search results');
      }
    })
    .catch(error => {
      console.error('Error:', error);
    });
    const modal = bootstrap.Modal.getOrCreateInstance(document.getElementById('filterModal'));
    document.querySelectorAll('.modal-backdrop').forEach(el => el.remove());
    modal.hide();
    
  });


  function category() {
    const buttonWrapper = document.querySelector('.menu-button-wrapper');
    let menu = buttonWrapper.querySelector('.dropdown-menu-category');

    if (!menu) {
      menu = document.createElement('div');
      menu.classList.add('dropdown-menu-category');
      buttonWrapper.appendChild(menu);
      
      // Tải danh mục
      fetch('/get-category', {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json'
        }
      })
      .then(res => res.json())
      .then(data => {
        menu.innerHTML = ''; 
        data.forEach(item => {
          const a = document.createElement('a');
          a.classList.add('dropdown-item-category');
          a.href = `/list/category/${item.categoryID}`;
          a.innerText = item.name;
          menu.appendChild(a);
        });
      });

      // Đóng menu khi click ngoài
      document.addEventListener('click', (e) => {
        if (!buttonWrapper.contains(e.target)) {
          menu.classList.remove('show');
        }
      });
    }
    menu.classList.toggle('show');
  }

  document.addEventListener('DOMContentLoaded', () => {
    const buttonWrapper = document.querySelector('.menu-button-wrapper');
    buttonWrapper.addEventListener('click', (e) => {
      e.stopPropagation();
    });
  });
  const formSearch = document.getElementById("form-search");
  if(formSearch){
    formSearch.addEventListener("submit",(e)=>{
      e.preventDefault();
      const content = document.getElementById("query").value;
      fetch(`/search?query=${content}`, {
        method: 'GET',
        headers: {
        'Content-Type': 'application/json'
        }
      })
      .then(res => {
        if (res.ok) {
        window.location.href = `/search?query=${content}`;
        } else {
        console.error('Failed to fetch search results');
        }
      })
      .catch(error => {
        console.error('Error:', error);
      });
      })
  }